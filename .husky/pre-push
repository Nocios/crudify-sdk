#!/usr/bin/env sh

# Pre-push hook: auto-bump patch version before push

# Check if the last commit is already a version bump
LAST_COMMIT_MSG=$(git log -1 --pretty=%B)
if echo "$LAST_COMMIT_MSG" | grep -q "^chore: bump version"; then
  # Already bumped, let the push proceed
  echo "Version already bumped, pushing..."
  exit 0
fi

echo "Bumping patch version..."

# Get current version
CURRENT_VERSION=$(node -p "require('./package.json').version")

# Bump patch version without creating a git tag
npm version patch --no-git-tag-version

# Get new version
NEW_VERSION=$(node -p "require('./package.json').version")

# Stage the version changes
git add package.json package-lock.json

# Create commit with version bump
git commit -m "chore: bump version to v$NEW_VERSION"

echo ""
echo "Version bumped: $CURRENT_VERSION -> $NEW_VERSION"
echo "Run 'git push' again to push with the new version."

# Abort this push - user needs to push again to include the bump commit
exit 1
